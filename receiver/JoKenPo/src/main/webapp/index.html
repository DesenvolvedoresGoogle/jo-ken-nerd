<!--
Reference: https://github.com/googlecast/CastHelloText-android
-->
<!DOCTYPE html>
<html>
    <head>
        <title>JKPLS</title>
    </head>
    <body>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js"></script>
        <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
        <link href="bootstrap.min.css" rel="stylesheet" type="text/css"/>
        <link href="bootstrap-theme.min.css" rel="stylesheet" type="text/css"/>
        <script src="gameData.js" type="text/javascript"></script>
        <script type="text/javascript">
            var mPlayer1 = -1;
            var mPlayer2 = -1;

            window.onload = function() {
                cast.receiver.logger.setLevelValue(0);
                window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
                console.log('Starting Receiver Manager JKPLS');

                // handler for the 'ready' event
                castReceiverManager.onReady = function(event) {
                    console.log('Received Ready event: ' + JSON.stringify(event.data));
                    window.castReceiverManager.setApplicationState("Application status is ready...");
                };

                // handler for 'senderconnected' event
                castReceiverManager.onSenderConnected = function(event) {
                    console.log('Received Sender Connected event: ' + event.data);
                    console.log(window.castReceiverManager.getSender(event.data).userAgent);
                };

                // handler for 'senderdisconnected' event
                castReceiverManager.onSenderDisconnected = function(event) {
                    console.log('Received Sender Disconnected event: ' + event.data);
                    if (event.senderId == mPlayer1.senderId) {
                        mPlayer1 = -1;
                    }
                    if (event.senderId == mPlayer2.senderId) {
                        mPlayer2 = -1;
                    }
                    if (window.castReceiverManager.getSenders().length == 0) {
                        window.close();
                    }
                };

                // handler for 'systemvolumechanged' event
                castReceiverManager.onSystemVolumeChanged = function(event) {
                    console.log('Received System Volume Changed event: ' + event.data['level'] + ' ' +
                            event.data['muted']);
                };

                // create a CastMessageBus to handle messages for a custom namespace
                window.messageBus =
                        window.castReceiverManager.getCastMessageBus(
                                'urn:x-cast:com.littleredgroup.jkpls');

                // handler for the CastMessageBus message event
                window.messageBus.onMessage = function(event) {
                    var json = JSON.parse(event.data);
                    console.log('>>>>>>>SenderId: ' + event.senderId);
                    console.log('>>>>>>>name: ' + json.name);
                    console.log('>>>>>>>action ' + json.action);
                    
                    actions(json.action, json, event.senderId);
                    
                    //json.error = 'passando mensagem de erro' + event.senderId;
                    //event.data = JSON.stringify(json);
                    //window.messageBus.broadcast(event.senderId + ' --- ' + event.data);
                    //window.messageBus.send(event.senderId, event.data);
                    //console.log('>>>>>>>sended')
                    
                    // inform all senders on the CastMessageBus of the incoming message event
                    // sender message listener will be invoked
                    //window.messageBus.send(event.senderId, event.data);
                }

                // initialize the CastReceiverManager with an application status message
                window.castReceiverManager.start({statusText: "Application is starting"});
                console.log('Receiver Manager started');
            };

            function actions(action, data, senderId) {
                if (action == 'connect') {
                    connect(data.name, senderId);
                }
                if (action == 'choice') {
                    choice(data.value, senderId);
                }
            }
            
            function choice(value, senderId) {
                if (mPlayer1.senderId == senderId) {
                    mPlayer1.choice == value;
                }
                if (mPlayer2.senderId == senderId) {
                    mPlayer2.choice == value;
                }
                if (mPlayer1 != -1 && mPlayer2 != -1) {
                    
                }
            }

            function connect(nome, senderId) {
                
                if ((mPlayer1 != -1) && (mPlayer1.senderId == senderId)) {
                    error.mensagem = 'Erro: voce ja esta conectado';
                    var json = JSON.create(error);
                    window.messageBus.send(mPlayer1.senderId, JSON.stringify(json));
                    return;
                }
                if ((mPlayer2 != -1) && (mPlayer2.senderId == senderId)) {
                    error.mensagem = 'Erro: voce ja esta conectado';
                    var json = JSON.create(error);
                    window.messageBus.send(mPlayer1.senderId, JSON.stringify(json));
                    return;
                }

                if (mPlayer1 == -1) {
                    mPlayer1 = new Object();
                    mPlayer1.name = nome;
                    mPlayer1.senderId = senderId;
                    mPlayer1.choice = -1;
                    updatePlayerName(1, nome);
                    console.log('Jogador 1 entrou');
                } else if (mPlayer2 == -1) {
                    mPlayer2 = new Object();
                    mPlayer2.name = name;
                    mPlayer2.senderId = senderId;
                    mPlayer2.choice = -1;
                    updatePlayerName(2, nome);
                    console.log('Jogador 2 entrou');
                } else {
                    console.log('Unable to join a full game.');
                    window.messageBus.send(senderId, '{ "error":"A sala est√° cheia"}');
                    return;
                }

                //console.log('mPlayer1: ' + JSON.stringify(JSON.create(mPlayer1)));
                //console.log('mPlayer2: ' + JSON.stringify(JSON.create(mPlayer2)));

                if (mPlayer1 != -1 && mPlayer2 != -1) {
                    //var json = JSON.parse('{ "sucess":"conectados com sucesso" }');
                    window.messageBus.broadcast('{ "sucess":"conectados com sucesso" }');
                }
            }
            ;

        </script>

        <div class="row" style="margin-top: 5%">
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-12">
                        <h2 class="text-center" id="player1name">Aguardando jogador...</h2>
                    </div>
                </div>
                <div class="row">
                    <div class="text-center" id="load1">
                        <img src="loader.GIF" alt=""/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <p class="text-center" id="escolha1"></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-12">
                        <h2 class="text-center" id="player2name">Aguardando jogador...</h2>
                    </div>
                </div>
                <div class="row">
                    <div class="text-center" id="load2">
                        <img src="loader.GIF" alt=""/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <p class="text-center" id="escolha2"></p>
                    </div>
                </div>
            </div>
        </div>
        <!--<button id="botao">Click</button>-->
    </body>
</html>